# Финальное исправление доски объявлений

## Проблемы, которые были обнаружены:

1. **Tick метод не регистрировался** - блок `BountyBoard` не имел регистрации `BlockEntityTicker`
2. **Квесты не генерировались** - `tryInitialPopulation()` не вызывался из-за отсутствия tick
3. **Поврежденные квесты** - существующие квесты имели неправильный класс "Неизвестный"
4. **Отладочный вывод заголовка** - показывал ключ перевода вместо переведенного текста

## Исправления:

### 1. BountyBoard.java

- Добавлен импорт `BlockEntityTicker` и `BlockEntityType`
- Добавлен метод `getTicker()` для регистрации tick обработчика
- Добавлена принудительная инициализация при открытии доски
- Добавлена принудительная регенерация если квестов нет

### 2. BountyBoardBlockEntity.java

- Убран вызов `generateRandomQuests()` из конструктора
- Улучшен метод `tryInitialPopulation()` с проверками мира
- Добавлен метод `forceRegenerateQuests()` для принудительной регенерации
- Улучшен метод `refreshQuests()` с полной очисткой
- Добавлена отладочная информация для диагностики классов квестов
- Исправлен метод `isPristine()` для правильной проверки пустоты

### 3. BountyBoardScreen.java

- Убран отладочный вывод заголовка

### 4. TestBountyBoardFixCommand.java

- Создана команда `/test_bounty_fix` для диагностики и исправления
- Показывает информацию о загруженных квестах
- Находит ближайшую доску и принудительно регенерирует квесты

### 5. Origins.java

- Зарегистрирована новая команда тестирования

## Логика работы:

1. При старте сервера квесты загружаются из JSON файлов через `QuestResourceReloadListener`
2. При создании `BountyBoardBlockEntity` квесты НЕ генерируются (мир еще недоступен)
3. Каждый tick вызывается `tryInitialPopulation()`, который проверяет нужна ли инициализация
4. При открытии доски дополнительно вызывается принудительная инициализация
5. Если квестов нет, вызывается `forceRegenerateQuests()` для полной регенерации

## Тестирование:

1. Запустите игру
2. Создайте или найдите доску объявлений
3. Используйте команду `/test_bounty_fix` для диагностики
4. Если квесты не отображаются, используйте `/force_clear_board` для принудительной очистки
5. Откройте доску объявлений - должны появиться квесты

## Команды для исправления:

- `/test_bounty_fix` - диагностика состояния доски и квестов
- `/force_clear_board` - принудительная очистка и регенерация квестов на ближайшей доске

## Ожидаемый результат:

- Доска объявлений показывает правильный заголовок "Доска объявлений"
- В интерфейсе отображаются квесты из JSON файлов
- Квесты имеют правильные классы (warrior, cook, courier, etc.)
- Квесты можно принимать и выполнять

## Отладочная информация:

В логах должны появиться сообщения:

- "tryInitialPopulation() вызван. world: ServerLevel[...]"
- "generateRandomQuests() вызван. world: ServerLevel[...]"
- "Доступно квестов из JSON: 120"
- "Добавлен JSON квест: [название] (класс: [класс]) в слот [номер]"

## Команды для исправления:

- `/test_bounty_fix` - диагностика состояния доски и квестов
- `/force_clear_board` - принудительная очистка и регенерация квестов на ближайшей доске

## Если проблема остается:

1. Проверьте логи на наличие ошибок загрузки квестов
2. Убедитесь, что JSON файлы квестов корректны
3. Используйте `/force_clear_board` для принудительной регенерации
4. Проверьте, что у игрока правильный класс (origins:cook, origins:warrior, etc.)
5. Перезапустите сервер для полной перезагрузки квестов

## Дополнительные улучшения:

- Добавлен метод `getValidQuestCount()` для проверки количества валидных квестов
- Улучшена логика `tryInitialPopulation()` - теперь регенерирует квесты если их нет или они невалидны
- Добавлена команда `/force_clear_board` для принудительного исправления проблемных досок
