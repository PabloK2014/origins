# Исправления системы билетов квестов

## Проблема
Система квестов работала неправильно - игроки не могли принимать квесты через билеты, получая сообщение "у вас уже есть активный квест". Система пыталась принимать квесты напрямую вместо создания билетов в инвентаре.

## Внесенные изменения

### 1. QuestManager.java
- **Изменена структура данных**: `Map<UUID, ActiveQuest>` → `Map<UUID, List<ActiveQuest>>`
- **Поддержка нескольких квестов**: Теперь игрок может иметь несколько активных квестов одновременно
- **Обновлены методы**:
  - `hasActiveQuest(PlayerEntity player)` - проверяет наличие любых активных квестов
  - `hasActiveQuest(PlayerEntity player, String questId)` - проверяет конкретный квест
  - `startQuest()` - добавляет квест в список активных квестов игрока
  - `completeQuest()` - удаляет конкретный квест из списка
  - `cancelQuest()` - отменяет конкретный квест
  - `tick()` - обновлен для работы со списками квестов

### 2. QuestInventoryManager.java
- **Увеличен лимит квестов**: `MAX_ACTIVE_QUESTS = 1` → `MAX_ACTIVE_QUESTS = 5`
- Теперь игрок может иметь до 5 активных квестов одновременно

### 3. QuestTicketAcceptanceHandler.java
- **Исправлена логика проверки**: Теперь проверяется наличие конкретного квеста, а не любого активного квеста
- **Улучшена валидация**: `questManager.hasActiveQuest(player)` → `questManager.hasActiveQuest(player, quest.getId())`

### 4. BountyBoardScreen.java
- **Исправлен метод acceptQuestDirectly()**: Теперь использует `QuestTicketAcceptanceHandler` вместо прямой отправки пакетов
- **Правильная интеграция**: Система теперь создает билеты в инвентаре игрока при принятии квестов

### 5. Тестирование
- Создан `QuestTicketSystemTest.java` для проверки основной функциональности
- Добавлены тесты для проверки лимита квестов и создания обработчиков

## Как теперь работает система

1. **Принятие квеста**:
   - Игрок нажимает ЛКМ по квесту на доске объявлений
   - Система создает билет квеста и помещает его в инвентарь игрока
   - Квест автоматически считается принятым
   - Игрок может принять до 5 квестов одновременно

2. **Отслеживание прогресса**:
   - Прогресс отображается в tooltip билета в инвентаре
   - Система автоматически отслеживает выполнение целей квеста
   - Билет визуально изменяется при готовности к сдаче

3. **Завершение квеста**:
   - Игрок нажимает ПКМ билетом по доске объявлений
   - Система проверяет выполнение всех условий
   - При успехе выдается награда и билет исчезает

4. **Отмена квеста**:
   - Игрок может выбросить билет для отмены квеста
   - Прогресс квеста очищается
   - Билет возвращается на доску объявлений

## Статус задач
- ✅ Задача 5: Реализовать отображение прогресса квеста в tooltip билета
- ✅ Задача 6: Реализовать завершение квеста через ПКМ билетом по доске

## Следующие шаги
- Задача 7: Реализовать систему отмены квестов через выбрасывание билета
- Задача 8: Добавить защиту от дублирования квестов
- Задача 9: Реализовать синхронизацию состояния между клиентом и сервером